# =============================================
# DevOps Lab Assignment 2
# Multi-Stage CI/CD Pipeline (Self-Hosted Agent)
# Flask Poll App
# =============================================

trigger:
  branches:
    include:
      - main

variables:
  - group: poll-app-vg

stages:

# ---------------------------------------------
# Stage 1 — Build & Test
# ---------------------------------------------
- stage: Build
  displayName: "Stage 1 - Build and Test"
  jobs:
    - job: BuildTest
      pool:
        name: 'local-pool'          # ⭐ SELF HOSTED AGENT POOL

      steps:

        # --- Use Python 3.11 installed on your VM ---
        - script: |
            sudo ln -sf /usr/bin/python3.11 /usr/bin/python3
            sudo ln -sf /usr/bin/pip3.11 /usr/bin/pip3
          displayName: "Select Python 3.11 from VM"

        - script: |
            python3 --version
            pip3 --version
          displayName: "Verify Python Version"

        # --- Install dependencies ---
        - script: |
            pip3 install --upgrade pip
            pip3 install -r requirements.txt
          displayName: "Install Python Dependencies"

        # --- Run Pytest Tests ---
        - script: |
            pytest tests/ -v
          displayName: "Run Unit Tests"

        # --- Package Build Artifact ---
        - task: ArchiveFiles@2
          displayName: "Archive Application"
          inputs:
            rootFolderOrFile: "$(System.DefaultWorkingDirectory)"
            includeRootFolder: false
            archiveType: zip
            archiveFile: "$(Build.ArtifactStagingDirectory)/poll-app.zip"

        - task: PublishBuildArtifacts@1
          displayName: "Publish Build Artifact"
          inputs:
            PathtoPublish: "$(Build.ArtifactStagingDirectory)"
            ArtifactName: "poll-app-drop"


# ---------------------------------------------
# Stage 2 — Deploy to DEV
# ---------------------------------------------
- stage: DeployDev
  displayName: "Stage 2 - Deploy to DEV"
  dependsOn: Build
  condition: succeeded()

  jobs:
    - deployment: DeployDevJob
      displayName: "Deploy to DEV Environment"
      environment: "DEV"
      pool:
        name: 'local-pool'          # ⭐ SELF HOSTED AGENT

      strategy:
        runOnce:
          deploy:
            steps:

              - task: DownloadBuildArtifacts@0
                inputs:
                  artifactName: "poll-app-drop"

              - task: AzureWebApp@1
                displayName: "Deploy to DEV App Service"
                inputs:
                  azureSubscription: "$(AZURE_SERVICE_CONNECTION)"
                  appName: "$(DEV_APP_NAME)"
                  package: "$(Pipeline.Workspace)/poll-app-drop/poll-app.zip"

              - task: AzureAppServiceSettings@1
                displayName: "Set DEV Environment Variables"
                inputs:
                  azureSubscription: "$(AZURE_SERVICE_CONNECTION)"
                  appName: "$(DEV_APP_NAME)"
                  appSettings: |
                    [
                      {
                        "name": "ENV_LABEL",
                        "value": "DEV"
                      },
                      {
                        "name": "ENV_COLOR",
                        "value": "#2196F3"
                      },
                      {
                        "name": "SECRET_KEY",
                        "value": "$(DEV_SECRET_KEY)"
                      }
                    ]

              - script: |
                  curl -f https://$(DEV_APP_NAME).azurewebsites.net/health
                displayName: "Smoke Test - DEV"


# ---------------------------------------------
# Stage 3 — Deploy to STAGING
# ---------------------------------------------
- stage: DeployStage
  displayName: "Stage 3 - Deploy to STAGING"
  dependsOn: DeployDev
  condition: succeeded()

  jobs:
    - deployment: DeployStageJob
      displayName: "Deploy to STAGING Environment"
      environment: "STAGING"
      pool:
        name: 'local-pool'          # ⭐ SELF HOSTED AGENT

      strategy:
        runOnce:
          deploy:
            steps:

              - task: DownloadBuildArtifacts@0
                inputs:
                  artifactName: "poll-app-drop"

              - task: AzureWebApp@1
                displayName: "Deploy to STAGING App Service"
                inputs:
                  azureSubscription: "$(AZURE_SERVICE_CONNECTION)"
                  appName: "$(STAGE_APP_NAME)"
                  package: "$(Pipeline.Workspace)/poll-app-drop/poll-app.zip"

              - task: AzureAppServiceSettings@1
                displayName: "Set STAGING Environment Variables"
                inputs:
                  azureSubscription: "$(AZURE_SERVICE_CONNECTION)"
                  appName: "$(STAGE_APP_NAME)"
                  appSettings: |
                    [
                      {
                        "name": "ENV_LABEL",
                        "value": "STAGING"
                      },
                      {
                        "name": "ENV_COLOR",
                        "value": "#FF9800"
                      },
                      {
                        "name": "SECRET_KEY",
                        "value": "$(STAGE_SECRET_KEY)"
                      }
                    ]

              - script: |
                  curl -f https://$(STAGE_APP_NAME).azurewebsites.net/health
                displayName: "Smoke Test - STAGING"
