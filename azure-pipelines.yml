# =============================================
# DevOps Lab Assignment 2 – Self Hosted Agent
# Flask Poll App CI/CD
# =============================================

trigger:
  branches:
    include:
      - main

variables:
  - group: poll-app-vg

stages:

# ---------------------------------------------
# Stage 1 — Build & Test
# ---------------------------------------------
- stage: Build
  displayName: "Stage 1 - Build and Test"
  jobs:
    - job: BuildTest
      pool:
        name: 'local-pool'

      steps:

        # Use Python from VM
        - script: |
            sudo ln -sf /usr/bin/python3.11 /usr/bin/python3
            sudo ln -sf /usr/bin/pip3.11 /usr/bin/pip3
          displayName: "Configure Python 3.11"

        - script: |
            python3 --version
            pip3 --version
          displayName: "Verify Python Version"

        # Create virtual environment
        - script: |
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
          displayName: "Create Virtual Environment & Install Dependencies"

        # Run unit tests inside venv
        - script: |
            source venv/bin/activate
            pytest tests/ -v
          displayName: "Run Unit Tests"

        # Package application
        - task: ArchiveFiles@2
          inputs:
            rootFolderOrFile: "$(System.DefaultWorkingDirectory)"
            includeRootFolder: false
            archiveType: zip
            archiveFile: "$(Build.ArtifactStagingDirectory)/poll-app.zip"

        - task: PublishBuildArtifacts@1
          inputs:
            PathtoPublish: "$(Build.ArtifactStagingDirectory)"
            ArtifactName: "poll-app-drop"


# ---------------------------------------------
# Stage 2 — Deploy to DEV
# ---------------------------------------------
- stage: DeployDev
  displayName: "Stage 2 - Deploy to DEV"
  dependsOn: Build
  condition: succeeded()

  jobs:
    - deployment: DeployDevJob
      environment: "DEV"
      pool:
        name: 'local-pool'

      strategy:
        runOnce:
          deploy:
            steps:

              - task: DownloadBuildArtifacts@0
                inputs:
                  artifactName: "poll-app-drop"

              - task: AzureWebApp@1
                inputs:
                  azureSubscription: "$(AZURE_SERVICE_CONNECTION)"
                  appName: "$(DEV_APP_NAME)"
                  package: "$(Pipeline.Workspace)/poll-app-drop/poll-app.zip"

              - task: AzureAppServiceSettings@1
                inputs:
                  azureSubscription: "$(AZURE_SERVICE_CONNECTION)"
                  appName: "$(DEV_APP_NAME)"
                  appSettings: |
                    [
                      {"name": "ENV_LABEL", "value": "DEV"},
                      {"name": "ENV_COLOR", "value": "#2196F3"},
                      {"name": "SECRET_KEY", "value": "$(DEV_SECRET_KEY)"}
                    ]

              - script: |
                  curl -f https://$(DEV_APP_NAME).azurewebsites.net/health
                displayName: "Smoke Test - DEV"


# ---------------------------------------------
# Stage 3 — Deploy to STAGING
# ---------------------------------------------
- stage: DeployStage
  displayName: "Stage 3 - Deploy to STAGING"
  dependsOn: DeployDev
  condition: succeeded()

  jobs:
    - deployment: DeployStageJob
      environment: "STAGING"
      pool:
        name: 'local-pool'

      strategy:
        runOnce:
          deploy:
            steps:

              - task: DownloadBuildArtifacts@0
                inputs:
                  artifactName: "poll-app-drop"

              - task: AzureWebApp@1
                inputs:
                  azureSubscription: "$(AZURE_SERVICE_CONNECTION)"
                  appName: "$(STAGE_APP_NAME)"
                  package: "$(Pipeline.Workspace)/poll-app-drop/poll-app.zip"

              - task: AzureAppServiceSettings@1
                inputs:
                  azureSubscription: "$(AZURE_SERVICE_CONNECTION)"
                  appName: "$(STAGE_APP_NAME)"
                  appSettings: |
                    [
                      {"name": "ENV_LABEL", "value": "STAGING"},
                      {"name": "ENV_COLOR", "value": "#FF9800"},
                      {"name": "SECRET_KEY", "value": "$(STAGE_SECRET_KEY)"}
                    ]

              - script: |
                  curl -f https://$(STAGE_APP_NAME).azurewebsites.net/health
                displayName: "Smoke Test - STAGING"
